<?xml version="1.0" encoding="utf-8"?>
<document>
  <properties>
    <title>Building Pustefix</title>
  </properties>

  <body>
    <section name="Building pustefix">
      <subsection name="Directory tree">
        <p>Important directories</p>
        <ul>
          <li><p><b>src</b> Java source of the core</p></li>
          <li><p><b>docs</b> Outdated documentation.</p></li>
          <li><p><b>xdocs</b> Documentation in xdoc format. xdoc is Maven's documentation
          format. It's derived from Apache's anakia format, which in turn is derived
          from the stylebook format used for most of the Jakarta website.</p></li>
        </ul>
      </subsection>
      <subsection name="Core">
        <p>Pustefix core features an <a href="http://ant.apache.org">Ant</a> build.</p>
        <p>To build the core with all projects:</p>
        <source>ant -Dmakemode=test</source>
        <p>Alternatively you can set the environment variable MAKE_MODE to the value "test" instead
        of having to supply it via the commandline every time</p>
        <p>You may want to run
        <source>ant generate -Dmakemode=test</source>
        to pre-process all the templates up-front. This speeds up the first hit of a page
        in applications since the page doesn't need to be build from scratch then.</p>
        <p>To get a list of available targets:</p>
        <source>ant -projecthelp</source>
      </subsection>
      <subsection name="Web site">
        <p>The web site is built with <a href="http://maven.apache.org">Maven</a>.</p>
        <p>To update the website:</p>
        <ol>
          <li><p>Make sure that <code>currentVersion</code> in <code>project.xml</code>
            is set propertly.</p></li>
          <li><p>Optional: Run
            <source>maven xdoc</source>
            to build the documentation from the <code>xdocs</code> directory. Check the result
            at <code>target/docs/index.html</code>. Fix problems and repeat if necessary.</p></li>
          <li><p>Run
            <source>maven site</source>
            to generate the website on your machine. Check the result (in particular: the
            project reports) at <code>target/docs/index.html</code>. Fix problems and repeat if
            necessary.</p></li>
          <li><p>Run
            <source>maven site:sshdeploy -Dmaven.username=&lt;yourlogin&gt;</source>
            to upload the website. Uses ssh to transfer the website into a temporary directory
            and - if successfull - replaces the existing site with a single <code>mv</code> command.
            If you're asked for an ssh username you probably forgot to specify
            <code>-Dmaven.username</code>.
          </p></li>
        </ol>
      </subsection>
      <subsection name="Release a new version">
        <ol>
            <li><p>Adjust version number in <code>build.xml</code>, <code>project.xml</code>,
              and <code>xdoc/index.xml</code>.</p></li>
            <li><p>In <code>xdocs/changes.xml</code>: Adjust version number and release date.
              Document important changes.</p></li>
            <li><p>Optional: Run <code>ant notag</code> and test the results in pfixschlund</p></li>
            <li><p>Optional: Update the web site.</p></li>
            <li><code>cvs commit</code></li>
            <li><p>Run <code>ant dist</code> to build the distribution and tag the repository.</p></li>
            <li><p>Upload to sourceforge: 
              <code>maven sourceforge:deploy -Dmaven.username=XXX -Dmaven.sourceforge.password=YYY</code></p></li>
            <li><p>Bump the version number in <code>build.xml</code>, <code>project.xml</code>,
              <code>xdoc/index.xml</code>, and <code>xdoc/changes.xml</code>.</p></li>
            <li><code>cvs commit</code></li>
         </ol>
      </subsection>
      <subsection name="Upgrade environment">
        <p>To replace the core files in an existing environment:</p>
        <ol>
          <li>Download the new <code>pfixcore-x.y.z.jar</code> file and the corresponding
          <code>pfixcore-data.x.y.z.tar.gz</code> file
          from <a href="download.html">here</a></li>
          <li><p>Replace the core files in <code>yourenv/lib</code>
          with the downloaded version.
          </p></li>
          <li>Rebuild your environment with ant</li>
        </ol>
        <p> If your environment is somewhat old, it's possible that
        the build process itself has changed, too. In this case it may help
        to copy the file <code>skel/build.xml</code> to the file
        <code>build-skel.xml</code> in your environment.
        </p>
      </subsection>
    </section>
  </body>
</document>
