<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "ant.dtd">
<!-- ant.dtd is generated by target dtd. This is not done automatically.
If any problems arise either regenerate ant.dtd by invoking ant dtd
or delete the DOCTYPE definition -->

<project name="pfixcore" default="all" basedir=".">
  <!-- override properties -->
  <property name="dir.projects"           location="example"/>
  <property name="dir.jni"                location="jni"/>
  <property name="exclude.examples"       value="de/skelexamples/**/*.*"/>

  <import file="skel/build-skel.xml"/>

  <!-- additional properties -->
  <property name="dir.dist"               location="dist"/>
  <property name="file.jnipkg"            location="${dir.jni}/${name.jnipkg}"/>
  <property name="project.version"        value="0.8.8" description="the version to use for pfixcore-*.*"/>
  <property name="dir.toconf"             value="${dir.projects}/common/conf/"/>
  <property name="name.pfixcore_jar"      value="${project.name}-${project.version}.jar"/>
  <property name="file.pfixcore_jar"      location="${dir.dist}/${name.pfixcore_jar}"/>
  <property name="name.pfixcore_data_tgz" value="${project.name}-data-${project.version}.tar.gz"/>
  <property name="file.pfixcore_data_tgz" location="${dir.dist}/${name.pfixcore_data_tgz}"/>
  <property name="name.pfixcore_skel_tgz" value="${project.name}-skel-${project.version}.tar.gz"/>
  <property name="file.pfixcore_skel_tgz" location="${dir.dist}/${name.pfixcore_skel_tgz}"/>
  <property name="name.pfixcore_examples_tgz" value="${project.name}-examples-${project.version}.tar.gz"/>
  <property name="file.pfixcore_examples_tgz" location="${dir.dist}/${name.pfixcore_examples_tgz}"/>
  <property name="name.testskel"          value="testskel"/>
  <property name="dir.testskel"           location="${name.testskel}"/>
  <property name="dir.examplepage"        location="${dir.projects}/simplepage"/>
  <property name="name.examplepage"       value="simplepage"/>
  <property name="dir.examplelink"        location="${dir.projects}/simplelink"/>
  <property name="name.examplelink"       value="simplelink"/>
  <property name="dir.exampleform"        location="${dir.projects}/simpleform"/>
  <property name="name.exampleform"       value="simpleform"/>

  <!-- override targets -->
    
  <target name="jni" depends="init, ant-tasks-compile">
    <ant dir="${dir.jni}"/>
  </target>

  <target name="dist-jni">
    <ant dir="${dir.jni}" target="dist"/>
  </target>

  <!-- TODO: always compiles before invoking skel.ant-tasks? -->
  <target name="ant-tasks" depends="ant-tasks-compile, skel.ant-tasks"/>
    
  <target name="init" depends="skel.init">
    <mkdir dir="${dir.dist}"/>
  </target>
    
  <target name="ant-tasks-compile" depends="tomcat.dir.opt, init" description="compiles java files needed by ant-tasks and jni">
    <javac
     srcdir="${dir.src}"
     destdir="${dir.build}"
     includes="de/schlund/pfixcore/util/Xslt*.java, de/schlund/pfixcore/util/GenerateSCodes.java, de/schlund/pfixcore/util/*Task.java, de/schlund/pfixxml/util/StringUtil.java, de/schlund/pfixcore/webservice/config/*.java, de/schlund/pfixcore/webservice/generate/*.java, de/schlund/pfixxml/loader/ObjectBuilder.java"
     debug="${debug}"
     classpathref="cp.classpath"
     sourcepath="${dir.src}"
     encoding="${javac.encoding}"
     >
    </javac>
  </target>

  <target name="clean-project" depends="skel.clean-project">
    <delete dir="${dir.dist}"/>
    <!-- Delete empty htdocs and img dirs in the dist examples -->
    <delete includeemptydirs="true">
      <fileset dir="${dir.examplepage}" includes="htdocs/**"/>
      <fileset dir="${dir.examplepage}" includes="img/**"/>
      <fileset dir="${dir.examplelink}" includes="htdocs/**"/>
      <fileset dir="${dir.examplelink}" includes="img/**"/>
      <fileset dir="${dir.exampleform}" includes="htdocs/**"/>
      <fileset dir="${dir.exampleform}" includes="img/**"/>
    </delete>
  </target>
        
  <target name="realclean-core"><!-- override target - we don't delete the core directory here -->
    <delete dir="${dir.tomcat}"/>
    <delete dir="${dir.testskel}"/>
  </target>
    
  <target name="init-data">
    <!-- override skel.init-data: do nothing -->
  </target>
    
  <target name="dist" depends="clean, init, dist-examples" description="Builds release files in dist directory, tags cvs.">
    <property name="dist.autotagmessage" value="${tstamp.autotag}"/>
    <!-- looks funny, but if someone called something like
         "ant jar dist" the jar file would have a wrong CVS_AUTOTAG file -->
    <antcall target="skeleton" inheritall="true">
      <param name="autotagmessage" value="${dist.autotagmessage}"/>
    </antcall>
    <cvs command="tag -c ${dist.autotagmessage}"/>
  </target>

  <target name="notag" depends="clean, dist-examples" description="Builds release files in dist directory without tagging cvs.">
    <antcall target="skeleton" inheritall="true"/>
  </target>

  <!-- Building the basic examples for dist -->
  <target name="dist-examples" depends="clean, init" description="Builds three basic examples as a pustefix turorial">
    <echo message="Building ${name.pfixcore_examples_tgz} in dist directory"/>

    <!-- creating the empty htdocs and img directories -->
    <mkdir dir="${dir.examplepage}/htdocs"/>
    <mkdir dir="${dir.examplepage}/img"/>
    <mkdir dir="${dir.examplelink}/htdocs"/>
    <mkdir dir="${dir.examplelink}/img"/>
    <mkdir dir="${dir.exampleform}/htdocs"/>
    <mkdir dir="${dir.exampleform}/img"/>

    <!-- Deleting the old tar and also the configuration files -->
    <delete file="${file.pfixcore_examples_tgz}">
      <fileset dir="${dir.examplepage}/conf" excludes="**.in"/>
      <fileset dir="${dir.examplelink}/conf" excludes="**.in"/>
      <fileset dir="${dir.exampleform}/conf" excludes="**.in"/>
    </delete>

    <!-- Building the example tar with the main java and iwrp files -->
    <tar destfile="${file.pfixcore_examples_tgz}" compression="gzip">
      <tarfileset dir="${dir.examplepage}" includes="**" prefix="${name.examplepage}"/>
      <tarfileset dir="${dir.projects}" includes="README_EXAMPLES.txt"/>
      <tarfileset dir="${dir.examplelink}" includes="**" prefix="${name.examplelink}"/>
      <tarfileset dir="${dir.exampleform}" includes="**" prefix="${name.exampleform}"/>
      <tarfileset dir="${dir.src}" includes="de/skelexamples/DemoText.iwrp" prefix="src"/>
      <tarfileset dir="${dir.src}" includes="de/skelexamples/ContextDemoText.java" prefix="src"/>
      <tarfileset dir="${dir.src}" includes="de/skelexamples/ContextDemoTextImpl.java" prefix="src"/>
      <tarfileset dir="${dir.src}" includes="de/skelexamples/DemoTextHandler.java" prefix="src"/>
    </tar>
  </target>


  <!-- a target to create a new project -->
  <target name="new-basicapp" depends="compile" description="Builds a naked application and creates the basic stuff">
    <java classname="de.schlund.pfixcore.util.basicapp.InitNewPfixProject">
      <classpath refid="cp.classpath"/>
    </java>
  </target>

  <target name="fixtabs">
    <fixcrlf srcdir="${basedir}" includes="build.xml, skel/build.xml, jni/build.xml" tab="remove" tablength="4"/>
  </target>

  <target name="skeleton" depends="tomcat.dir, ant-tasks, fixtabs, compile, jar, data">
    <echo message="Building ${name.pfixcore_skel_tgz} in dist directory"/>
    <tar destfile="${file.pfixcore_skel_tgz}" compression="gzip">
      <tarfileset dir="${dir.skel}" prefix="skel"/>
      <tarfileset dir="${dir.metainf}" includes="${name.cvsautotag}" prefix="skel"/>
      <tarfileset dir="${dir.lib}" includes="*.jar, tomcat/README" prefix="skel/lib"/>
      <tarfileset dir="${dir.dist}" includes="${name.pfixcore_jar}" prefix="skel/lib"/>
      <tarfileset dir="${dir.dist}" includes="${name.pfixcore_data_tgz}" prefix="skel/lib"/>
      <tarfileset dir="${basedir}" includes="ant.dtd" prefix="skel"/>
      <tarfileset dir="${basedir}" includes="INSTALL" prefix="skel"/>
      <tarfileset dir="${dir.toconf}" includes="newproject.prop.in newprjlog.xml.in" prefix="skel/projects/common/conf"/>
    </tar>
  </target>

  <target name="data" depends="init, stylesheets, autotag">
    <echo message="Building ${name.pfixcore_data_tgz} in dist directory" />
    <copy file="${dir.metainf}/${name.cvsautotag}" tofile="${dir.projects}/core/${name.cvsautotag}"/>
    <tar destfile="${file.pfixcore_data_tgz}" compression="gzip">
      <tarfileset dir="${dir.projects}/core" prefix="core"/>
      <tarfileset file="${basedir}/skel/build-skel.xml" prefix="core/build"/>
    </tar>
    <delete file="${dir.projects}/core/${name.cvsautotag}"/>
  </target>

  <target name="jar" depends="autotag, dist-jni">
    <mkdir dir="${dir.dist}" description="creates ${name.pfixcore_jar}"/>
    <jar destfile="${file.pfixcore_jar}">
      <fileset dir="${basedir}" includes="META-INF/**"/>
      <fileset dir="${dir.build}">
        <exclude name="de/schlund/util/statuscodes/StatusCodeLib.class"/>
        <exclude name="de/schlund/pfixcore/example/iwrapper/DemoText.class"/>
        <exclude name="de/schlund/pfixcore/example/ContextDemoText.class"/>
        <exclude name="de/schlund/pfixcore/example/ContextDemoTextImpl.class"/>
        <exclude name="de/schlund/pfixcore/example/DemoTextHandler.class"/>
      </fileset>
      <fileset dir="${dir.jni}" includes="${name.jnipkg}"/>
    </jar>
  </target>

  <target name="autotag" depends="init">
    <!-- property gets overridden when calling target dist -->
    <property name="autotagmessage" value="${tstamp.autotag} (not tagged in cvs)"/>
    <!-- make echo insert a newline into the file with &#010; -->
    <echo file="${dir.metainf}/${name.cvsautotag}" message="${autotagmessage}&#010;"/>
  </target>

  <target name="test-skeleton" description="extracts skel.jar, copies sample files, runs ant">
    <delete dir="${dir.testskel}"/>
    <mkdir dir="${dir.testskel}"/>
    <untar src="${file.pfixcore_skel_tgz}" dest="${dir.testskel}" compression="gzip"/>
    <copy todir="${dir.testskel}/skel/src">
      <fileset dir="${dir.src}" includes="de/schlund/pfixcore/example/**"/>
    </copy>
    <!-- Copying over sample application for testing purposes -->
    <copy todir="${dir.testskel}/skel/projects">
      <fileset dir="${dir.projects}" includes="sample1/**"/>
    </copy>
    <!-- DocumentRoot for sample application, apache fails to start without -->
    <mkdir dir="${dir.testskel}/skel/projects/htdocs"/>
    <!-- jakarta-tomcat-x.x.xx.tar.gz is not included in skeleton anymore -->
    <copy todir="${dir.testskel}/skel/lib/tomcat">
        <fileset dir="${dir.lib}/tomcat">
          <include name="*.tar.gz"/>
        </fileset>
    </copy>
    <exec dir="${dir.testskel}/skel" executable="ant" failonerror="true">
    </exec>
  </target>
</project>

<!--
Local Variables:
sgml-indent-step: 4
End:
-->
