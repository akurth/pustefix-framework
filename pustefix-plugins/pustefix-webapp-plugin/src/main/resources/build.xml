<project>
  <target name="generate" depends="data, apt, pfixroot, buildtimeprops, webxml"/>

  <target name="data">
    <delete dir="${pfixroot}/core"/>
    <untar dest="${pfixroot}" compression="gzip" overwrite="true" src="${data.tar.gz}"/>
  </target>
  	
  <target name="apt">
    <taskdef name="pfx-apt"
      classpathref="plugin.classpath"
      classname="de.schlund.pfixcore.generator.iwrpgen.AptTask"
      description="Pustefix APT task" />
    <pfx-apt
      classpathref="plugin.classpath"
      srcdir="${basedir}/src/main/java"
      destdir="${basedir}/target/classes"
      preprocessdir="${aptdir}"
      encoding="UTF-8"
      factory="de.schlund.pfixcore.util.CommonAnnotationProcessorFactory" />
  </target>
	
  <target name="webxml">
  	<taskdef name="pfx-xslt"
     classname="de.schlund.pfixcore.util.XsltGenericTask"
     classpathref="plugin.classpath" />
    <taskdef name="pfx-webxml"
     classname="org.pustefixframework.config.build.CreateWebXmlTask"
     classpathref="plugin.classpath"
     description="Creates WEB-INF/web.xml config files for each project" />

  	<property name="webinf" location="${pfixroot}/.."/>
    <copy toDir="${webinf}" flatten="true">
      <resources>
        <javaresource name="build/web.xml" classpathref="plugin.classpath"/>
      	
      	<!-- TODO: temporary solution because pfx-xslt cannot read styles from resources: -->
        <javaresource name="build/create_defaultwebxml.xsl" classpathref="plugin.classpath"/>
        <javaresource name="build/create_webxml.xsl" classpathref="plugin.classpath"/>
      </resources>
    </copy>
  	<move file="${webinf}/web.xml" tofile="${webinf}/web.xml.tmp"/>
    <pfx-xslt
       style="${webinf}/create_defaultwebxml.xsl"
       srcdir="${webinf}"
       destdir="${webinf}"
       includes="web.xml.tmp"
       extension=""
       validate="false"
     />
    <pfx-webxml
         stylesheet="${webinf}/create_webxml.xsl" 
         webappsdir="${webinf}"
         commonconfig="${basedir}/src/main/pustefix/conf/projects.xml"
         projectconfig="${basedir}/src/main/pustefix/conf/project.xml"/>
  </target>

  <target name="pfixroot">
    <copy toDir="${pfixroot}">
        <fileset dir="${basedir}/src/main/pustefix"/>
    </copy>
  </target>
	
  <target name="buildtimeprops">
    <taskdef
      name="pfx-buildtime-props"
      classname="de.schlund.pfixxml.config.BuildTimePropTask"
      classpathref="plugin.classpath"
    />
    <mkdir dir="${pfixroot}"/>
    <pfx-buildtime-props
      file="${pfixroot}/buildtime.prop"
      mode="${makemode}"
      uid="uid"
      machine="machine"
      fqdn="fqdn"
      docroot="docroot"
     />
    <echo append="true" file="${pfixroot}/buildtime.prop">
__antprop_makemode=${makemode}
__antprop_standalone.tomcat=${standalone.tomcat}
    </echo>

  </target>
</project>
