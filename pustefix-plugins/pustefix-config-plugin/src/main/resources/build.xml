<project>
  <target name="generate" depends="data, apt, pfixroot, webxml, modules, buildtimeprops">
  	<echo>generate</echo>
  </target>

  <target name="data">
    <delete dir="${pfixroot}/core"/>
    <untar dest="${pfixroot}" compression="gzip" overwrite="true" 
           src="${user.home}/.m2/repository/org/pustefixframework/pustefix-core/0.14.0-SNAPSHOT/pustefix-core-0.14.0-SNAPSHOT-data.tar.gz"/>
  </target>


  	
  <target name="apt">
  	<echo>cp: ${maven.plugin.classpath}"</echo>
  		
    <path id="maven.plugin.classpath">
      <pathelement path="${maven.plugin.classpath}"/>
  	</path>

    <taskdef name="pfx-apt"
      classpathref="maven.plugin.classpath"
      classname="de.schlund.pfixcore.generator.iwrpgen.AptTask"
      description="Pustefix APT task" />
      
    <!--  apt  -->
    
    <pfx-apt
      classpathref="maven.plugin.classpath"
      srcdir="${basedir}/src/main/java"
      destdir="${basedir}/target/classes"
      preprocessdir="${aptdir}"
      encoding="UTF-8"
      factory="de.schlund.pfixcore.util.CommonAnnotationProcessorFactory" />
      
  </target>
	
  <target name="webxml">
  	<property name="webinf" location="${pfixroot}/.."/>
    <copy toDir="${webinf}" flatten="true">
      <resources>
        <javaresource name="build/web.xml" classpathref="maven.plugin.classpath"/>
      </resources>
      <filterset>
        <filter token="PFIXROOT" value="${pfixroot}"/>
      </filterset>
    </copy>
  </target>

  <target name="pfixroot">
    <copy toDir="${pfixroot}">
        <fileset dir="${basedir}/src/main/pustefix"/>
    </copy>
  </target>
	
  <target name="modules">
    <!--  modules -->
    
    <taskdef
       name="pfx-unpack-jar-module"
       classname="de.schlund.pfixcore.util.UnpackModuleTask"
       classpathref="maven.plugin.classpath"
       description="Checks JARs for a Pustefix module deployment descriptor and unpacks the resources" />

  	<property name="dir.extract.modules" location="${pfixroot}/modules"/>
    <mkdir dir="${dir.extract.modules}"/>
    <!--  TODO: basedir: wo kommen die modules her -->
    <pfx-unpack-jar-module srcdir="${basedir}" extracttodir="${dir.extract.modules}" includes="${basedir}" />
    <touch file="${dir.extract.modules}/TIMESTAMP"/>
    <!--  TODO:
    <foreach param="tmp.modules.buildxml" target="extract-modules-call-ant" inheritall="true" inheritrefs="true">
      <fileset dir="${dir.extract.modules}">
        <include name="*/build.xml"/>
      </fileset>
    </foreach>
    <antcall target="scmerge-modules"/>
     -->
  </target>
  <target name="buildtimeprops">
    <taskdef
      name="pfx-buildtime-props"
      classname="de.schlund.pfixxml.config.BuildTimePropTask"
      classpathref="maven.plugin.classpath"
    />
    <mkdir dir="${basedir}/target/classes"/>
    <pfx-buildtime-props
      file="${basedir}/target/classes/buildtime.prop"
      mode="${makemode}"
      uid="uid"
      machine="machine"
      fqdn="fqdn"
      docroot="docroot"
     />
    <echo append="true" file="${basedir}/target/classes/buildtime.prop">
__antprop_makemode=${makemode}
__antprop_standalone.tomcat=${standalone.tomcat}
    </echo>

  </target>
</project>
