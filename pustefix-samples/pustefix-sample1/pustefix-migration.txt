================================================
Migrating Pustefix applications from 0.14 to 1.0
================================================

- pustefix-webapp-plugin aus pom.xml l√∂schen

- Create folders
    src/main/resources
    src/main/resources/META-INF
    src/main/resources/META-INF/pustefix
    src/main/resources/PUSTEFIX-INF
    
- Move resource subfolders (dyntxt, htdocs, img, script, txt, xml, xsl, ...)
    from src/main/webapp 
      to src/main/resources/PUSTEFIX-INF
    
- Move (and rename) main project configuration file
    from src/main/webapp/WEB-INF/project.xml
      to src/main/resources/META-INF/pustefix-application.xml

- Remove src/main/webapp/WEB-INF/web.xml

- Remove src/main/webapp/WEB-INF/pfixlog.xml
    (TODO: describe how to do logging, e.g. converting pfixlog.xml to logback.xml and creating fragment)

- Move remaining configuration files (config.conf.xml, direct.conf.xml, depend.xml, spring.xml, scriptedflow, ...) 
    to src/main/resources/META-INF/pustefix

- Remove src/main/webapp folder (which should be empty now)

- Adapt configuration in src/main/resources/META-INF/pustefix-application.xml

    replace <project-config xmlns="http://www.pustefix-framework.org/2008/namespace/project-config">
    by <pustefix-application xmlns="http://www.pustefix-framework.org/2009/namespace/application-config">
    
    change <config-file> paths (within <xml-generator>, <context-xml-service>,<direct-output-service>)
    from docroot:/WEB-INF/...
    to bundle:/META-INF/pustefix/...
    
    remove <path>core/img</path> and <path>core/script</path> from <static> section
    
- Adapt configuration in src/main/resources/META-INF/pustefix/depend.xml

    replace <make project="..." lang="...">
    by <xml-generator-config project="..." lang="..." 
          xmlns="http://www.pustefix-framework.org/2008/namespace/xml-generator-config">
          
    replace <include stylesheet="path/to/file" module="amodule"/> by
      <include stylesheet="bundle://BUNDLE_SYMBOLIC_NAME_AMODULE/path/to/file"/>
    
- Replace config-includes by extension-points, configuration-fragments by extensions
    (TODO: describe details)    
    
- Signature of StatusCode setters in casters, pre/post checks has to be changed from String to StatusCode
  (because the according classes are loaded with another classloader and don't see StatusCodeLibs)
  
- PustefixPropertiesPersister/Spring-PropertyPlaceholderConfigurer
    
- Changes in pom.xml:

    change packaging from 'war' to 'bundle'
    
    add maven-bundle-plugin to plugins:
    
      <plugin>
         <groupId>org.apache.felix</groupId>
         <artifactId>maven-bundle-plugin</artifactId>
         <extensions>true</extensions>
         <version>2.0.0</version>
         <configuration>
            <instructions>
              <Bundle-RequiredExecutionEnvironment>J2SE-1.5</Bundle-RequiredExecutionEnvironment>
              <Include-Resource>src/main/resources</Include-Resource>
              <Export-Package></Export-Package>
              <Import-Package>*, org.aopalliance.aop;version="1.0.0", org.springframework.aop.scope;version="2.5.6.A", org.springframework.aop;version="2.5.6.A", org.springframework.aop.framework;version="2.5.6.A", net.sf.cglib.core;version="2.1.3", net.sf.cglib.proxy;version="2.1.3", net.sf.cglib.reflect;version="2.1.3"</Import-Package>
            </instructions>
         </configuration>
         <executions>
            <execution>
               <id>bundle-manifest</id>
               <phase>process-classes</phase>
               <goals>
                  <goal>manifest</goal>
               </goals>
            </execution>
         </executions>
      </plugin>
      
    add pustefix-autoconfig-plugin (optional)
    
      <plugin>
        <groupId>org.pustefixframework.maven.plugins</groupId>
        <artifactId>pustefix-autoconfig-plugin</artifactId>
        <version>1.0.0</version>
        <configuration>
          <mode>${mode}</mode>
          <logLevel>${logLevel}</logLevel>
        </configuration>
        <executions>
          <execution>
            <goals>
              <goal>generate-config-fragments</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    
    add pustefix-bundleindex-plugin (optional)
    
      <plugin>
        <groupId>org.pustefixframework.maven.plugins</groupId>
        <artifactId>pustefix-bundleindex-plugin</artifactId>
        <version>1.0.0</version>
        <executions>
          <execution>
            <goals>
              <goal>update-bundle-index</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      
    add pustefix-launcher-plugin (optional)
    
      <plugin>
        <groupId>org.pustefixframework.maven.plugins</groupId>
        <artifactId>pustefix-launcher-plugin</artifactId>
        <version>1.0.0</version>
      </plugin>

    add profiles
    
      <profile>
      <id>test</id>
      <activation>
        <activeByDefault>true</activeByDefault>
      </activation>
      <properties>
        <mode>test</mode>
        <logLevel>info</logLevel>
      </properties>
    </profile>
    <profile>
      <id>prod</id>
      <properties>
        <mode>prod</mode>
        <logLevel>warn</logLevel>
      </properties>
     </profile>

- Add the following provision.conf file to the root folder:

#Provisioning configuration

#Exclude bundles resolved from POM but not wanted at runtime (by Bundle-SymbolicName)
!com.springsource.org.apache.log4j

#Additional bundles required to launch/deploy the application

#HttpService implementation
mvn:org.apache.felix/org.apache.felix.http.jetty/[1.0.1]/jar

#Pustefix core modules
mvn:org.pustefixframework.osgi/pustefix-osgi-spring-dm-extender/1.0.3.SNAPSHOT/jar
mvn:org.pustefixframework.osgi/pustefix-osgi-logservice-bridge/1.0.3.SNAPSHOT/jar@3

#Logging
mvn:ch.qos.logback/com.springsource.ch.qos.logback.classic/[0.9.15]/jar@3
mvn:ch.qos.logback/com.springsource.ch.qos.logback.core/[0.9.15]/jar@3
mvn:org.slf4j/com.springsource.slf4j.api/[1.5.6]/jar@3
mvn:org.slf4j/com.springsource.slf4j.bridge/[1.5.6]/jar@3
mvn:org.slf4j/com.springsource.slf4j.org.apache.log4j/[1.5.6]/jar@3
mvn:org.slf4j/jcl-over-slf4j/[1.5.6]/jar@3

#Logging configuration
file:target/generated-bundles/org.pustefixframework.logback.config-1.0.0.jar@3

#Pustefix runtime configuration
file:target/generated-bundles/org.pustefixframework.runtime.config-1.0.0.jar@3



- View XML changes:

  Replace module names by Bundle-SymbolicNames, e.g.:
   <pfx:include part="partA" href="txt/common.xml" module="OLD_MODULE_NAME"/> to
    <pfx:include part="partA" href="txt/common.xml" module="BUNDLE_SYMBOLIC_NAME"/>

  Images from modules now are directly referenced from the bundle (no mapping/extracting to module folder any more),
  so the according <pfx:image> tags have to be adapted, examples:
  
    from <pfx:image src="modules/mymodule/img/myimage.jpg"/>
    to <pfx:image src="img/myimage.jpg" module="myBundleSymbolicName"/> 

    low-level, e.g. in Javascript:
    window.document.images['myimg'].src = "/bundle://myBundleSymbolicName/PUSTEFIX-INF/img/myimage.jpg";

    (TODO: should use request prefix mapping here)

===========================================
Migrating Pustefix modules from 0.14 to 1.0
===========================================

- Adapt main configuration file src/main/resources/META-INF/pustefix-module.xml

    replace <module-descriptor> root tag by 
    <pustefix-module xmlns="http://www.pustefix-framework.org/2009/namespace/module-config">

    remove <module-name> and <resources> elements
    
    replace module name by the according Bundle-SymbolicName in <override-modules><module name"...">
    
    add <dynamic-includes> tag around <override-modules>
    
- Changes in pom.xml:

    change packaging from 'jar' to 'bundle'
    
    add maven-bundle-plugin to plugins:
    
      <plugin>
         <groupId>org.apache.felix</groupId>
         <artifactId>maven-bundle-plugin</artifactId>
         <extensions>true</extensions>
         <version>2.0.0</version>
         <configuration>
            <instructions>
              <Bundle-RequiredExecutionEnvironment>J2SE-1.5</Bundle-RequiredExecutionEnvironment>
              <Include-Resource>src/main/resources</Include-Resource>
              <Export-Package></Export-Package>
              <Import-Package>*, org.aopalliance.aop;version="1.0.0", org.springframework.aop.scope;version="2.5.6.A", org.springframework.aop;version="2.5.6.A", org.springframework.aop.framework;version="2.5.6.A", net.sf.cglib.core;version="2.1.3", net.sf.cglib.proxy;version="2.1.3", net.sf.cglib.reflect;version="2.1.3"</Import-Package>
            </instructions>
         </configuration>
         <executions>
            <execution>
               <id>bundle-manifest</id>
               <phase>process-classes</phase>
               <goals>
                  <goal>manifest</goal>
               </goals>
            </execution>
         </executions>
      </plugin>
    
